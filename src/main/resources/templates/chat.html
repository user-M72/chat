<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application</title>
    <style>
        body { font-family: Arial, sans-serif; margin:0; height:100vh; display:flex; }
        .user-form { margin:auto; text-align:center; }
        .user-form input { display:block; margin:10px auto; padding:8px; width:200px; }
        .user-form button { padding:8px 15px; cursor:pointer; }
        .hidden { display:none !important; }

        .chat-container { flex:1; display:flex; }
        .users-list { width:250px; background:#f8f9fa; border-right:1px solid #e5e7eb; display:flex; flex-direction:column; justify-content:space-between; }
        .users-list-container { flex:1; overflow-y:auto; }
        .users-list h2 { margin:0; padding:12px; background:#2563eb; color:white; font-size:16px; }
        .users-list ul { margin:0; padding:0; list-style:none; }
        .users-list li { padding:10px; cursor:pointer; display:flex; align-items:center; border-bottom:1px solid #e5e7eb; }
        .users-list li.active { background:#e0e7ff; font-weight:bold; }
        .users-list img { width:28px; height:28px; margin-right:10px; }
        .nbr-msg { background:red; color:white; border-radius:50%; padding:2px 6px; font-size:12px; margin-left:auto; }
        .chat-area { flex:1; display:flex; flex-direction:column; }
        #chat-messages { flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; }
        .message { margin-bottom:10px; padding:8px 12px; border-radius:10px; max-width:70%; word-wrap:break-word; }
        .message.sender { background:#d1fae5; align-self:flex-end; }
        .message.receiver { background:#f1f5f9; align-self:flex-start; }
        .message-input { display:flex; border-top:1px solid #e5e7eb; }
        .message-input input { border:none; padding:12px; flex:1; outline:none; font-size:14px; }
        .message-input button { background:#2563eb; color:white; border:none; padding:12px 18px; cursor:pointer; font-size:14px; }
        .logout { display:block; padding:10px; text-align:center; color:#2563eb; text-decoration:none; font-weight:bold; }
        .logout:hover { text-decoration:underline; }
        h2.header { position:absolute; top:0; left:0; width:100%; text-align:center; background:#2563eb; color:white; margin:0; padding:10px; }
        .status { margin-left: 8px; font-size: 12px; font-weight: bold; }
        .status.online { color: green; }
        .status.offline { color: gray; }
    </style>
</head>
<body>

<h2 class="header">One to One Chat | Spring Boot & WebSocket</h2>

<div class="user-form" id="username-page">
    <h2>Enter Chatroom</h2>
    <form id="usernameForm">
        <label for="nickname">Nickname:</label>
        <input type="text" id="nickname" name="nickname" required>
        <label for="fullname">Full Name:</label>
        <input type="text" id="fullname" name="fullname" required>
        <button type="submit">Enter Chatroom</button>
    </form>
</div>

<div class="chat-container hidden" id="chat-page">
    <div class="users-list">
        <div class="users-list-container">
            <h2>Users</h2>
            <ul id="connectedUsers"></ul>
        </div>
        <div>
            <p id="connected-user-fullname"></p>
            <a class="logout" href="javascript:void(0)" id="logout">Logout</a>
        </div>
    </div>

    <div class="chat-area">
        <div id="chat-messages"></div>
        <form id="messageForm" name="messageForm" class="hidden">
            <div class="message-input">
                <input autocomplete="off" type="text" id="message" placeholder="Type your message...">
                <button>Send</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    'use strict';

    const usernamePage = document.querySelector('#username-page');
    const chatPage = document.querySelector('#chat-page');
    const usernameForm = document.querySelector('#usernameForm');
    const messageForm = document.querySelector('#messageForm');
    const messageInput = document.querySelector('#message');
    const chatArea = document.querySelector('#chat-messages');
    const logout = document.querySelector('#logout');

    let stompClient = null;
    let nickname = null;
    let fullname = null;
    let selectedUserId = null;

    function connect(event) {
        nickname = document.querySelector('#nickname').value.trim();
        fullname = document.querySelector('#fullname').value.trim();

        if (nickname && fullname) {
            usernamePage.classList.add('hidden');
            chatPage.classList.remove('hidden');

            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, onConnected, onError);
        }
        event.preventDefault();
    }

    function onConnected() {
    stompClient.subscribe('/user/queue/messages', onMessageReceived);
    stompClient.subscribe('/topic/public', onMessageReceived);

    stompClient.send("/app/user.addUser", {}, JSON.stringify({
        nickname,
        fullName: fullname,
        status: 'ONLINE'
    }));
    document.querySelector('#connected-user-fullname').textContent = fullname;

    fetchUsers();
}

    async function fetchUsers() {
        const response = await fetch('/users');
        const users = await response.json();
        const list = document.getElementById('connectedUsers');
        list.innerHTML = '';

        users.forEach(user => {
            if(user.nickname !== nickname) addUserToList(user);
        });
    }

    function addUserToList(user) {
        if(document.getElementById(user.nickname)) return;

        const li = document.createElement('li');
        li.classList.add('user-item');
        li.id = user.nickname;

        const img = document.createElement('img');
        img.src = '../img/user_icon.png';
        img.alt = user.fullName;

        const spanName = document.createElement('span');
        spanName.textContent = user.fullName;

        const statusSpan = document.createElement('span');
        statusSpan.classList.add('status', user.status === "ONLINE" ? 'online' : 'offline');
        statusSpan.textContent = user.status === "ONLINE" ? "● Online" : "● Offline";

        const nbrMsg = document.createElement('span');
        nbrMsg.textContent = '0';
        nbrMsg.classList.add('nbr-msg', 'hidden');

        li.appendChild(img);
        li.appendChild(spanName);
        li.appendChild(statusSpan);
        li.appendChild(nbrMsg);

        li.addEventListener('click', userItemClick);
        document.getElementById('connectedUsers').appendChild(li);
    }

    function userItemClick(event) {
        document.querySelectorAll('.user-item').forEach(item => item.classList.remove('active'));
        messageForm.classList.remove('hidden');

        const clicked = event.currentTarget;
        clicked.classList.add('active');
        selectedUserId = clicked.id;
        fetchAndDisplayUserChat();

        const nbrMsg = clicked.querySelector('.nbr-msg');
        nbrMsg.classList.add('hidden');
        nbrMsg.textContent = '0';
    }

    function displayMessage(senderId, content) {
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message', senderId === nickname ? 'sender' : 'receiver');

        const p = document.createElement('p');
        p.textContent = content;
        messageContainer.appendChild(p);
        chatArea.appendChild(messageContainer);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    async function fetchAndDisplayUserChat() {
        if(!selectedUserId) return;
        const response = await fetch(`/message/${nickname}/${selectedUserId}`);
        const messages = await response.json();
        chatArea.innerHTML = '';
        messages.forEach(msg => displayMessage(msg.senderId, msg.content));
    }

    function onMessageReceived(payload) {
        const message = JSON.parse(payload.body);

        if (message.senderId && message.content) {
            if (selectedUserId &&
               (selectedUserId === message.senderId || selectedUserId === message.recipientId)) {
                displayMessage(message.senderId, message.content);
            } else {
                const userId = (message.senderId === nickname) ? message.recipientId : message.senderId;
                const notifiedUser = document.querySelector(`#${userId}`);
                if (notifiedUser) {
                    const nbrMsg = notifiedUser.querySelector('.nbr-msg');
                    nbrMsg.classList.remove('hidden');
                    nbrMsg.textContent = parseInt(nbrMsg.textContent) + 1;
                }
            }
        } else if (message.nickname && message.status) {
            updateUserStatus(message);
        }
    }

    function updateUserStatus(user) {
        const li = document.getElementById(user.nickname);
        if (li) {
            const statusSpan = li.querySelector('.status');
            statusSpan.textContent = user.status === "ONLINE" ? "● Online" : "● Offline";
            statusSpan.classList.remove('online', 'offline');
            statusSpan.classList.add(user.status === "ONLINE" ? 'online' : 'offline');
        } else {
            addUserToList(user);
        }
    }

    function sendMessage(event) {
        const content = messageInput.value.trim();
        if (content && stompClient && selectedUserId) {
            const chatMessage = {senderId: nickname, recipientId: selectedUserId, content, timestamp: new Date()};
            stompClient.send("/app/chat", {}, JSON.stringify(chatMessage));
            displayMessage(nickname, content);
            messageInput.value = '';
        }
        event.preventDefault();
    }

    function onLogout() {
        stompClient.send("/app/user.disconnectUser", {}, JSON.stringify({nickname, fullName: fullname, status: 'OFFLINE'}));
        window.location.reload();
    }

    usernameForm.addEventListener('submit', connect, true);
    messageForm.addEventListener('submit', sendMessage, true);
    logout.addEventListener('click', onLogout, true);
    window.onbeforeunload = () => onLogout();

    function onError() {
        alert('Could not connect to WebSocket server. Please refresh the page!');
    }
</script>
</body>
</html>
